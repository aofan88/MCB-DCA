#!/usr/bin/env python3
# Mcb_Daily_Scanner_1.2
# Nov/14/2025 â€” æ”¹é€²ï¼šHeader é¡¯ç¤ºå¯¦éš›åŸ·è¡Œæ™‚é–“ï¼›æ¯ç­† signal é¡¯ç¤ºè©²æ—¥ priceï¼›TG è¨Šæ¯æ ¼å¼å„ªåŒ–

import os
import requests
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# =====================================================
# ========== CONFIG ==========
# =====================================================

EOD_API_KEY = "69169ed4d171d2.32964392"   # â˜… API Key â˜…
USE_EOD = True

TELEGRAM_TOKEN = "8074680946:AAFshgFINNVlVYJFl88-E9z_o8Zj-KsfRSs"
TELEGRAM_CHAT_ID = "6027645130"

# 50 æª”ç¾Žè‚¡ï¼ˆEODHD æ ¼å¼ï¼‰
STOCK_LIST = [
    "AAPL.US","MSFT.US","NVDA.US","AMZN.US","GOOG.US","META.US",
    "TSLA.US","AVGO.US","JPM.US","BRK-B.US","V.US","MA.US",
    "HD.US","COST.US","WMT.US","MCD.US","KO.US","PEP.US",
    "NFLX.US","AMD.US","QCOM.US","INTC.US","TXN.US",
    "UNH.US","JNJ.US","MRK.US","ABBV.US","PFE.US",
    "XOM.US","CVX.US","COP.US","SLB.US",
    "CAT.US","DE.US","GE.US","UPS.US","FDX.US","BA.US",
    "LOW.US","TGT.US","SBUX.US","NKE.US","ADBE.US",
    "CRM.US","ORCL.US","IBM.US","CSCO.US","AMAT.US"
]

# Market Cipher B åƒæ•¸ï¼ˆèˆ‡ TradingView ä¸€è‡´ï¼‰
CHANNEL_LEN = 9
AVG_LEN = 12
ENTRY1 = -35
ENTRY2 = -60

LOOKBACK_DAYS = 10
CHECK_WINDOW_DAYS = 5
RECENT_SHOW_DAYS = 5

# OutPut 
OUT_DIR = "/Users/joechan/Documents/mcb_signals"
os.makedirs(OUT_DIR, exist_ok=True)

# =====================================================
# ========== EODHD Fetch ==========
# =====================================================

def eodhd_fetch(symbol, from_date, to_date):
    url = f"https://eodhistoricaldata.com/api/eod/{symbol}"
    params = {
        "from": from_date,
        "to": to_date,
        "api_token": EOD_API_KEY,
        "period": "d",
        "fmt": "json"
    }
    try:
        r = requests.get(url, params=params, timeout=15)
        if r.status_code != 200:
            print(f"[{symbol}] HTTP {r.status_code}: {r.text[:200]}")
            return None
        data = r.json()
        if not isinstance(data, list) or len(data) == 0:
            return None

        df = pd.DataFrame(data)
        df.rename(columns={
            "date":"Date","open":"Open","high":"High","low":"Low","close":"Close",
            "adjusted_close":"Adj Close","volume":"Volume"
        }, inplace=True)

        df["Date"] = pd.to_datetime(df["Date"])
        for c in ["Open","High","Low","Close"]:
            df[c] = pd.to_numeric(df[c], errors="coerce")

        df = df.dropna(subset=["Open","High","Low","Close"])
        df.sort_values("Date", inplace=True)
        df.reset_index(drop=True, inplace=True)
        return df

    except Exception as e:
        print(f"[{symbol}] EODHD error:", e)
        return None


# =====================================================
# ========== MCB Calculation ==========
# =====================================================

def compute_mcb(df):
    ap = (df["High"] + df["Low"] + df["Close"]) / 3
    esa = ap.ewm(span=CHANNEL_LEN).mean()
    d = abs(ap - esa).ewm(span=CHANNEL_LEN).mean()
    ci = (ap - esa) / (0.015 * d.replace(0, 1e-9))
    tci = ci.ewm(span=AVG_LEN).mean()

    df["wt1"] = tci
    df["wt2"] = df["wt1"].rolling(4).mean()
    return df


# =====================================================
# ========== TG ==========
# =====================================================

def telegram_send(text):
    if not TELEGRAM_TOKEN:
        return False
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": text, "parse_mode":"Markdown"}
        r = requests.post(url, data=payload, timeout=10)
        if not r.ok:
            print("TG send failed:", r.status_code, r.text[:200])
        return r.status_code == 200
    except Exception as e:
        print("TG exception:", e)
        return False


# =====================================================
# ========== MAIN SCANNER ==========
# =====================================================

def scan_once():
    run_time = datetime.now()
    run_time_str = run_time.strftime("%Y-%m-%d %H:%M")

    today = run_time.date()
    yesterday = today - timedelta(days=1)
    trade_date_str = yesterday.strftime("%Y-%m-%d")

    from_dt = today - timedelta(days=LOOKBACK_DAYS)

    all_signals = []

    print(f">>> Scanner running... (run_time={run_time_str}, trade_date={trade_date_str})")

    # ---- fetch loop ----
    for sym in STOCK_LIST:
        df = eodhd_fetch(sym,
            from_dt.strftime("%Y-%m-%d"),
            yesterday.strftime("%Y-%m-%d")
        )
        if df is None:
            print(f"[{sym}] fetch failed")
            continue

        df = compute_mcb(df).dropna().reset_index(drop=True)

        df["cross"]     = (df["wt1"].shift(1) < df["wt2"].shift(1)) & (df["wt1"] > df["wt2"])
        df["green_dot"] = df["cross"] & ((df["wt2"] - df["wt1"]) <= 0)
        df["buy1"]      = (df["green_dot"] & (df["wt1"] < ENTRY1)).astype(int)
        df["buy2"]      = (df["green_dot"] & (df["wt1"] < ENTRY2)).astype(int)

        recent_df = df.tail(CHECK_WINDOW_DAYS + 1)

        for _, row in recent_df.iterrows():
            if row["buy1"] == 1 or row["buy2"] == 1:
                all_signals.append({
                    "symbol": sym,
                    "signal_type": "2x" if row["buy2"] == 1 else "1x",
                    "signal_date": row["Date"].strftime("%Y-%m-%d"),
                    "price": float(row["Close"]),
                })

    # No signals?
    if not all_signals:
        summary = f"ðŸ“Œ MCB Scanner â€” {run_time_str}\n\n(No buy signals yesterday)"
        telegram_send(summary)
        print("No signals. Heartbeat sent.")
        return

    df_out = pd.DataFrame(all_signals)
    df_out = df_out.sort_values(["signal_date", "symbol"], ascending=[False, True])

    df_today = df_out[df_out["signal_date"] == trade_date_str]
    df_past  = df_out[df_out["signal_date"] < trade_date_str]

    # Save CSV
    out_file = f"{OUT_DIR}/signals_run_{today.strftime('%Y%m%d')}.csv"
    df_out.to_csv(out_file, index=False, float_format="%.6f")

    # ============================
    #   Telegram clean output
    # ============================
    text = f"ðŸ“Œ MCB Scanner â€” {run_time_str}\n\n"

    # Latest trading day
    if len(df_today) == 0:
        text += "(No buy signals yesterday)\n\n"
    else:
        text += "ðŸ”¥ Signals for Yesterday:\n"
        for _, r in df_today.iterrows():
            text += f"{r['symbol']} {r['signal_type']} @ ${r['price']:.2f}\n"
        text += "\n"

    # Past signals
    text += "ðŸ“… Signals Past Week\n\n"

    grouped = df_past.groupby("signal_date")
    for date, grp in grouped:
        text += f"â€¢ {date}\n"
        for _, r in grp.iterrows():
            text += f"{r['symbol']} {r['signal_type']} @ ${r['price']:.2f},\n"
        text += "\n"

    telegram_send(text)

    with open(f"{OUT_DIR}/signals_run_{today.strftime('%Y%m%d')}_summary.txt", "w") as f:
        f.write(text)

    print("TG sent.")
    print(f"Saved CSV: {out_file}")
    print("Done.")



# =====================================================
# ========== RUN ==========
# =====================================================

if __name__ == "__main__":
    print("MCB Daily Scanner (EODHDç‰ˆ) starting:", datetime.now().strftime("%Y-%m-%d %H:%M"))
    scan_once()
