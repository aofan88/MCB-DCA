#!/usr/bin/env python3
# Mcb_Daily_Scanner_1.1
# Nov/14/2025 11:22 OK 

import os
import requests
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

# =====================================================
# ========== CONFIG ==========
# =====================================================

EOD_API_KEY = "69169ed4d171d2.32964392"   # â˜… API Key â˜…
USE_EOD = True

TELEGRAM_TOKEN = "8074680946:AAFshgFINNVlVYJFl88-E9z_o8Zj-KsfRSs"
TELEGRAM_CHAT_ID = "6027645130"

# 50 æª”ç¾Žè‚¡ï¼ˆEODHD æ ¼å¼ï¼‰
STOCK_LIST = [
    "AAPL.US","MSFT.US","NVDA.US","AMZN.US","GOOG.US","META.US",
    "TSLA.US","AVGO.US","JPM.US","BRK-B.US","V.US","MA.US",
    "HD.US","COST.US","WMT.US","MCD.US","KO.US","PEP.US",
    "NFLX.US","AMD.US","QCOM.US","INTC.US","TXN.US",
    "UNH.US","JNJ.US","MRK.US","ABBV.US","PFE.US",
    "XOM.US","CVX.US","COP.US","SLB.US",
    "CAT.US","DE.US","GE.US","UPS.US","FDX.US","BA.US",
    "LOW.US","TGT.US","SBUX.US","NKE.US","ADBE.US",
    "CRM.US","ORCL.US","IBM.US","CSCO.US","AMAT.US"
]

# Market Cipher B åƒæ•¸ï¼ˆèˆ‡ TradingView ä¸€è‡´ï¼‰
CHANNEL_LEN = 9
AVG_LEN = 12
ENTRY1 = -35
ENTRY2 = -60

LOOKBACK_DAYS = 10
CHECK_WINDOW_DAYS = 5
RECENT_SHOW_DAYS = 5

# OutPut 
OUT_DIR = "/Users/joechan/Documents/mcb_signals"
# OUT_DIR ="/home/mcb/mcb_signals"

os.makedirs(OUT_DIR, exist_ok=True)

# =====================================================
# ========== EODHD Fetch ==========
# =====================================================

def eodhd_fetch(symbol, from_date, to_date):
    url = f"https://eodhistoricaldata.com/api/eod/{symbol}"
    params = {
        "from": from_date,
        "to": to_date,
        "api_token": EOD_API_KEY,
        "period": "d",
        "fmt": "json"
    }
    try:
        r = requests.get(url, params=params, timeout=10)
        if r.status_code != 200:
            return None
        data = r.json()
        if not isinstance(data, list) or len(data) == 0:
            return None

        df = pd.DataFrame(data)
        df.rename(columns={
            "date":"Date","open":"Open","high":"High","low":"Low","close":"Close",
            "adjusted_close":"Adj Close","volume":"Volume"
        }, inplace=True)

        df["Date"] = pd.to_datetime(df["Date"])
        for c in ["Open","High","Low","Close"]:
            df[c] = pd.to_numeric(df[c], errors="coerce")

        df = df.dropna(subset=["Open","High","Low","Close"])
        df.sort_values("Date", inplace=True)
        df.reset_index(drop=True, inplace=True)
        return df

    except Exception as e:
        print(f"[{symbol}] EODHD error:", e)
        return None


# =====================================================
# ========== MCB Calculation ==========
# =====================================================

def compute_mcb(df):
    ap = (df["High"] + df["Low"] + df["Close"]) / 3
    esa = ap.ewm(span=CHANNEL_LEN).mean()
    d = abs(ap - esa).ewm(span=CHANNEL_LEN).mean()
    ci = (ap - esa) / (0.015 * d.replace(0, 1e-9))
    tci = ci.ewm(span=AVG_LEN).mean()

    df["wt1"] = tci
    df["wt2"] = df["wt1"].rolling(4).mean()
    return df


# =====================================================
# ========== TG ==========
# =====================================================

def telegram_send(text):
    if not TELEGRAM_TOKEN:
        return False
    try:
        url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
        payload = {"chat_id": TELEGRAM_CHAT_ID, "text": text, "parse_mode":"Markdown"}
        r = requests.post(url, data=payload, timeout=10)
        return r.status_code == 200
    except:
        return False


# =====================================================
# ========== MAIN SCANNER ==========
# =====================================================

def scan_once():
    today = datetime.now().date()
    yesterday = today - timedelta(days=1)   # â˜… æœ€æ–°ä¿¡è™Ÿæ”¹ç‚ºæ˜¨å¤©äº¤æ˜“æ—¥
    today_str = yesterday.strftime("%Y-%m-%d")

    from_dt = today - timedelta(days=LOOKBACK_DAYS)

    all_signals = []

    print(">>> Scanner running...")

    # ---- loop symbols ----
    for sym in STOCK_LIST:
        df = eodhd_fetch(sym,
            from_dt.strftime("%Y-%m-%d"),
            yesterday.strftime("%Y-%m-%d")
        )

        if df is None:
            print(f"[{sym}] fetch failed")
            continue

        df = compute_mcb(df).dropna().reset_index(drop=True)

        df["cross"] = (df["wt1"].shift(1) < df["wt2"].shift(1)) & (df["wt1"] > df["wt2"])
        df["green_dot"] = df["cross"] & ((df["wt2"] - df["wt1"]) <= 0)
        df["buy1"] = (df["green_dot"] & (df["wt1"] < ENTRY1)).astype(int)
        df["buy2"] = (df["green_dot"] & (df["wt1"] < ENTRY2)).astype(int)

        recent_df = df.tail(CHECK_WINDOW_DAYS + 1)

        for _, row in recent_df.iterrows():
            if row["buy2"] == 1 or row["buy1"] == 1:
                all_signals.append({
                    "symbol": sym,
                    "signal_type": "2x" if row["buy2"] == 1 else "1x",
                    "signal_date": row["Date"].strftime("%Y-%m-%d"),
                    "wt1": float(row["wt1"])
                })

    # ---- no signals ----
    if not all_signals:
        telegram_send("ðŸ“­ MCBï¼šæœ€è¿‘ 5 æ—¥ç„¡ä»»ä½•ä¿¡è™Ÿã€‚")
        print("No signals.")
        return

    df_out = pd.DataFrame(all_signals)
    df_out = df_out.sort_values("signal_date", ascending=False)

    df_today = df_out[df_out["signal_date"] == today_str]
    df_past = df_out[df_out["signal_date"] < today_str]

    # save CSV
    out_file = f"{OUT_DIR}/signals_{yesterday.strftime('%Y%m%d')}.csv"
    df_out.to_csv(out_file, index=False, float_format="%.6f")

    # ---- summary for TG ----
    summary = f"ðŸ“Œ *MCB Scanner* æœ€æ–°äº¤æ˜“æ—¥ï¼š{today_str}\n"

    if len(df_today):
        summary += "\nðŸ”¥ *æœ€æ–°ä¿¡è™Ÿï¼ˆæ˜¨æ—¥ï¼‰* ðŸ”¥\n"
        for _, r in df_today.iterrows():
            summary += f"{r['symbol']}  {r['signal_type']}  (wt1={r['wt1']:.1f})\n"
    else:
        summary += "\n(æ˜¨æ—¥ç„¡æ–°ä¿¡è™Ÿ)\n"

    if len(df_past):
        summary += "\nðŸ“… *éŽåŽ» 5 æ—¥ä¿¡è™Ÿ*\n"
        for _, r in df_past.iterrows():
            summary += f"{r['symbol']} {r['signal_type']} @ {r['signal_date']} (wt1={r['wt1']:.1f})\n"

    with open(f"{OUT_DIR}/signals_{yesterday.strftime('%Y%m%d')}_summary.txt", "w") as f:
        f.write(summary)

    telegram_send(summary)
    print("TG sent.")
    print(f"Saved CSV: {out_file}")
    print("Done.")


# =====================================================
# ========== RUN ==========
# =====================================================

if __name__ == "__main__":
    print("MCB Daily Scanner (EODHDç‰ˆ) starting:", datetime.now().strftime("%Y-%m-%d %H:%M"))
    scan_once()
